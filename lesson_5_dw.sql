-- Запрос 1. производительность бригда по проектам
-- Вопрос: Какие бригады работают наиболее эффективно?
-- CTE для расчета ключевых показателей по бригадам
WITH team_stats AS (
    SELECT 
        f.team_sk,                                           -- Ключ бригады
        COUNT(*) AS total_tasks,                            -- Общее количество работ
        ROUND(AVG(f.quality_score), 2) AS avg_quality       -- Средняя оценка качества
    FROM fact_work_log f                                    -- Основная таблица фактов
    JOIN dim_date d ON f.date_sk = d.date_sk               -- Присоединяем даты
    WHERE d.year = 2024                                     -- Фильтруем 2024 год
    GROUP BY f.team_sk                                      -- Группируем по бригадам
    HAVING COUNT(*) >= 5                                    -- Минимум 5 записей
)
-- Основной запрос: получение названий бригад и их показателей
SELECT 
    t.name AS team_name,                                    -- Название бригады
    ts.total_tasks,                                         -- Количество работ
    ts.avg_quality                                          -- Средняя оценка
FROM dim_team t                                             -- Измерение бригад
JOIN team_stats ts ON t.team_sk = ts.team_sk               -- Присоединяем статистику
ORDER BY ts.avg_quality DESC;                              -- Сортируем по качеству


-- Запрос 2. Эффективность проектов по категориям
-- Вопрос: Как распределяются трудозатраты между проектами разных статусов и какое качество работ достигается?
SELECT 
    p.name AS project_name,              -- Название проекта для идентификации
    p.status,                            -- Текущий статус проекта (Planning, In Progress, etc.)
    p.contract_value,                    -- Стоимость контракта (бюджет проекта)
    SUM(f.work_hours) AS total_hours,    -- Общее количество отработанных часов по проекту
    ROUND(AVG(f.quality_score), 1) AS avg_quality  -- Средняя оценка качества работ (округлено до 1 знака)
FROM dim_project p                       -- Основная таблица проектов
LEFT JOIN fact_work_log f ON p.project_sk = f.project_sk  -- LEFT JOIN включает ВСЕ проекты,
                                        -- даже без записей в логах работ (например, только запланированные)
GROUP BY p.project_sk, p.name, p.status, p.contract_value  -- Группируем по проекту,
                                        -- включая все поля из SELECT, не входящие в агрегатные функции
ORDER BY 
    p.status,                           -- Первичная сортировка: по статусу (алфавитно)
    total_hours DESC;                   -- Вторичная сортировка: по убыванию отработанных часов
                                        -- (самые трудозатратные проекты в каждой группе статусов - наверху)
    
    
-- Запрос 3. Рейтинг техники по интенсивности использования
-- Вопрос: Как распределяется нагрузка между единицами оборудования компании?
SELECT 
    e.equipment_name,                    -- Название единицы техники (например: "Экскаватор JCB JS160")
    COUNT(*) AS usage_days,              -- Количество дней, когда техника использовалась
    SUM(f.equipment_hours) AS total_hours -- Общее количество отработанных техникой часов
FROM fact_work_log f                     -- Основная таблица фактов с записями о работах
JOIN dim_equipment e ON f.equipment_sk = e.equipment_sk  -- Присоединяем справочник техники 
WHERE f.equipment_hours > 0             -- Исключаем дни, когда техника не работала
GROUP BY e.equipment_name               -- Группируем все записи по каждой единице техники
HAVING COUNT(*) >= 3                    -- Показываем только активно используемую технику (минимум 3 дня работы для статистической значимости)
ORDER BY total_hours DESC;              -- Сортируем по убыванию общих часов работы  

-- Запрос 4. Качество работ по типам задач и месяцам
-- Вопрос: В какие периоды и на каких задачах качество работ снижается?
SELECT 
    d.year,                          -- Год выполнения работ
    d.month,                         -- Месяц выполнения работ
    tk.category AS task_category,    -- Категория задачи (например: фундамент, кровля, отделка)
    tk.complexity_level,             -- Уровень сложности задачи (простой, средний, сложный)
    COUNT(*) AS total_records,       -- Общее количество выполненных работ в данной категории
    ROUND(AVG(f.quality_score), 2) AS avg_quality,    -- Средняя оценка качества работ
    MIN(f.quality_score) AS min_quality,              -- Минимальная оценка качества
    MAX(f.quality_score) AS max_quality,              -- Максимальная оценка качества
    COUNT(CASE WHEN f.quality_score < 7 THEN 1 END) AS low_quality_count  -- Количество работ с низким качеством (менее 7 баллов)
FROM fact_work_log f             -- Основная таблица фактов с записями о выполненных работах
JOIN dim_task tk ON f.task_sk = tk.task_sk          -- Присоединяем справочник задач для получения категории и уровня сложности
JOIN dim_date d ON f.date_sk = d.date_sk            -- Присоединяем справочник дат для группировки по времени (год, месяц)
WHERE d.year = 2024             -- Анализируем только данные за 2024 год
GROUP BY d.year, d.month, tk.category, tk.complexity_level  -- Группируем по каждой уникальной комбинации: год + месяц + категория задачи + сложность
HAVING COUNT(*) >= 5            -- Показываем только группы с минимум 5 записями
ORDER BY 
    d.month,                     -- Первичная сортировка: по месяцам (январь → декабрь)
    avg_quality ASC;             -- Вторичная сортировка: по возрастанию среднего качества (проблемные области с низким качеством показываются первыми)